<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>VapeNsk</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            background: black;
            overflow: hidden;
            font-family: sans-serif;
        }

        .slide {
            position: absolute;
            width: 100vw;
            height: 100vh;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center top;
            color: white;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            box-sizing: border-box;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            animation-name: fade;
            animation-duration: 5s;
            animation-iteration-count: infinite;
        }

        .slide-text {
            width: 100%;
            padding: 20px;
            background: rgba(0, 0, 0, 0.5);
            text-align: center;
            font-size: 24px;
            word-wrap: break-word;
        }

        @keyframes fade {
            0% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }

        canvas {
            display: none;
        }
    </style>
</head>
<body>

<canvas id="colorCanvas" width="160" height="90"></canvas>

<script>
    let current = 0;
    let slides = [];

    async function loadSlides() {
        const res = await fetch('/VNShow/data.json');
        const data = await res.text();
        slides = JSON.parse(data.replace(/\\u([\da-f]{4})/gi,
            (match, p1) => String.fromCharCode(parseInt(p1, 16))
        ));
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–º–∏–Ω–∏—Ä—É—é—â–µ–≥–æ —Ü–≤–µ—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    function getDominantColor(img) {
        const canvas = document.getElementById("colorCanvas");
        const ctx = canvas.getContext("2d");

        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

        const colorMap = {};
        for (let i = 0; i < imageData.length; i += 4) {
            const r = imageData[i];
            const g = imageData[i+1];
            const b = imageData[i+2];

            if ((r > 240 && g > 240 && b > 240) || (r < 10 && g < 10 && b < 10)) continue;

            const key = `${Math.round(r / 10)*10},${Math.round(g / 10)*10},${Math.round(b / 10)*10}`;
            colorMap[key] = (colorMap[key] || 0) + 1;
        }

        let maxCount = 0;
        let dominantColor = "rgb(0,0,0)";
        for (const key in colorMap) {
            if (colorMap[key] > maxCount) {
                const [rr, gg, bb] = key.split(",").map(Number);
                dominantColor = `rgb(${rr}, ${gg}, ${bb})`;
                maxCount = colorMap[key];
            }
        }

        return dominantColor;
    }

    function cleanPostText(text) {
        if (!text) return "";

        return text
            .replace("–î–∞–Ω–Ω—ã–π –ø–æ—Å—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Ä–µ–∫–ª–∞–º–æ–π –∏ –Ω–µ—Å—ë—Ç –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä!", "")
            .replace(/–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –≤ –Ω–∞—à —Ç–µ–ª–µ–≥—Ä–∞–º–º –∫–∞–Ω–∞–ª\s*:\s*https?:\/\/t\.me\/vapensk_news/gi, '')
            .replace(/Vapensk\s*\|\s*News[\s\S]*?https:\/\/t\.me\/vapensk_news/gi, '')
            .replace(/(–ü—Ä–∞–≤—ã–π|–õ–µ–≤—ã–π|–ë–µ—Ä–¥—Å–∫):\s*[^\n]*/g, '')
            .replace(/üì±\+?[0-9]{6,}/g, '')
            .replace(/\s+/g, ' ')
            .trim();
    }

    function showNextSlide() {
        document.querySelectorAll('.slide').forEach(el => el.remove());

        const slideData = slides[current];

        const div = document.createElement('div');
        div.className = 'slide';

        if (slideData.image) {
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.src = slideData.image;

            img.onload = () => {
                const bgColor = getDominantColor(img);

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç —Å–≤–µ—Ä—Ö—É –æ—Ç —Ü–≤–µ—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫ —á—ë—Ä–Ω–æ–º—É
                div.style.backgroundImage = `linear-gradient(to bottom, ${bgColor}, black), url('${img.src}'`;
                div.style.backgroundSize = "contain";
                div.style.backgroundRepeat = "no-repeat";
                div.style.backgroundPosition = "center top";
                div.style.backgroundBlendMode = "normal";

                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –ø–æ–¥ —Ñ–æ—Ç–æ
                const textDiv = document.createElement('div');
                textDiv.className = 'slide-text';
                textDiv.innerText = cleanPostText(slideData.text || "");

                div.appendChild(textDiv);
                document.body.appendChild(div);
            };
        } else {
            div.style.background = "black";
            const textDiv = document.createElement('div');
            textDiv.className = 'slide-text';
            textDiv.innerText = cleanPostText(slideData.text || "");
            div.appendChild(textDiv);
            document.body.appendChild(div);
        }

        current = (current + 1) % slides.length;
    }

    setInterval(showNextSlide, 5000);
    loadSlides().then(() => {
        showNextSlide(); // –ü–µ—Ä–≤—ã–π —Å–ª–∞–π–¥ —Å—Ä–∞–∑—É
    });
</script>

</body>
</html>
